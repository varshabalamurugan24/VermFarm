<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VermaFarm - Smart Farming Marketplace</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
/* VermaFarm V2 - Enhanced Multi-User System Styles */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary: #2d5016;
    --secondary: #4a7c2c;
    --accent: #7cb342;
    --brown: #6d4c41;
    --light: #f1f8e9;
    --white: #ffffff;
    --gray: #757575;
    --dark: #1b3409;
    --danger: #d32f2f;
    --warning: #f57c00;
    --success: #388e3c;
    --info: #1976d2;
    --purple: #7b1fa2;
    --orange: #e65100;
    --border: #e0e0e0;
    --shadow: 0 2px 8px rgba(0,0,0,0.1);
    --shadow-lg: 0 4px 20px rgba(0,0,0,0.15);
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    line-height: 1.6;
    color: #333;
    background: #f5f5f5;
}

/* Utility Classes */
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px;
}

.hidden {
    display: none !important;
}

.btn {
    padding: 0.7rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}

.btn-primary {
    background: var(--accent);
    color: white;
}

.btn-primary:hover {
    background: var(--secondary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(74, 124, 44, 0.3);
}

.btn-secondary {
    background: var(--gray);
    color: white;
}

.btn-secondary:hover {
    background: #616161;
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-info {
    background: var(--info);
    color: white;
}

.btn-warning {
    background: var(--warning);
    color: white;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

.btn-block {
    width: 100%;
    display: block;
}

.card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--shadow);
    margin-bottom: 1.5rem;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--light);
}

.card-header h2 {
    color: var(--primary);
    font-size: 1.5rem;
}

.card-header h3 {
    color: var(--primary);
    font-size: 1.2rem;
}

/* Authentication Pages */
.auth-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    padding: 20px;
}

.auth-box {
    background: white;
    padding: 3rem;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
}

.auth-logo {
    text-align: center;
    margin-bottom: 2rem;
}

.auth-logo h1 {
    color: var(--primary);
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.auth-logo .logo-icon {
    font-size: 3rem;
}

/* User Type Selection */
.user-type-selection {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.user-type-card {
    border: 3px solid var(--border);
    border-radius: 12px;
    padding: 1.2rem;
    cursor: pointer;
    transition: all 0.3s;
    background: white;
}

.user-type-card:hover {
    border-color: var(--accent);
    box-shadow: 0 4px 12px rgba(124, 179, 66, 0.2);
}

.user-type-card.selected {
    border-color: var(--accent);
    background: var(--light);
}

.user-type-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.user-type-icon {
    font-size: 2rem;
}

.user-type-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--primary);
}

.user-type-description {
    font-size: 0.9rem;
    color: var(--gray);
    line-height: 1.4;
}

.user-type-features {
    list-style: none;
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: var(--gray);
}

.user-type-features li {
    padding: 0.2rem 0;
    padding-left: 1.2rem;
    position: relative;
}

.user-type-features li::before {
    content: '‚úì';
    position: absolute;
    left: 0;
    color: var(--success);
    font-weight: bold;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--gray);
    font-weight: 500;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 0.8rem;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--accent);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.auth-link {
    text-align: center;
    margin-top: 1.5rem;
    color: var(--gray);
}

.auth-link a {
    color: var(--accent);
    text-decoration: none;
    font-weight: 600;
}

.auth-link a:hover {
    text-decoration: underline;
}

.alert {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.alert-success {
    background: #e8f5e9;
    color: var(--success);
    border-left: 4px solid var(--success);
}

.alert-error {
    background: #ffebee;
    color: var(--danger);
    border-left: 4px solid var(--danger);
}

.alert-info {
    background: #e3f2fd;
    color: var(--info);
    border-left: 4px solid var(--info);
}

.alert-warning {
    background: #fff3e0;
    color: var(--warning);
    border-left: 4px solid var(--warning);
}

/* Main App Layout */
.app-layout {
    display: flex;
    min-height: 100vh;
}

/* Sidebar */
.sidebar {
    width: 260px;
    background: var(--primary);
    color: white;
    padding: 1.5rem;
    position: fixed;
    height: 100vh;
    overflow-y: auto;
    z-index: 100;
}

.sidebar.farmer {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
}

.sidebar.landowner {
    background: linear-gradient(135deg, var(--brown) 0%, #8d6e63 100%);
}

.sidebar.buyer {
    background: linear-gradient(135deg, var(--info) 0%, #1565c0 100%);
}

.sidebar-logo {
    display: flex;
    align-items: center;
    gap: 0.7rem;
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid rgba(255,255,255,0.2);
}

.sidebar-logo .icon {
    font-size: 2rem;
}

.user-badge {
    background: rgba(255,255,255,0.2);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    text-align: center;
    font-size: 0.85rem;
    margin-bottom: 1.5rem;
    font-weight: 600;
}

.sidebar-nav {
    list-style: none;
}

.sidebar-nav li {
    margin-bottom: 0.5rem;
}

.sidebar-nav a {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.9rem 1rem;
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    border-radius: 8px;
    transition: all 0.3s;
    font-weight: 500;
}

.sidebar-nav a:hover,
.sidebar-nav a.active {
    background: rgba(255,255,255,0.15);
    color: white;
}

.sidebar-nav .icon {
    font-size: 1.3rem;
}

.sidebar-footer {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 2px solid rgba(255,255,255,0.2);
}

.user-info {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    margin-bottom: 1rem;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
}

.user-details h4 {
    font-size: 0.95rem;
    margin-bottom: 0.2rem;
}

.user-details p {
    font-size: 0.8rem;
    opacity: 0.7;
}

.logout-btn {
    width: 100%;
    padding: 0.7rem;
    background: rgba(211, 47, 47, 0.2);
    color: white;
    border: 1px solid rgba(211, 47, 47, 0.4);
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.logout-btn:hover {
    background: rgba(211, 47, 47, 0.4);
}

/* Main Content */
.main-content {
    flex: 1;
    margin-left: 260px;
    padding: 2rem;
    background: #f5f5f5;
}

.page-header {
    margin-bottom: 2rem;
}

.page-header h1 {
    color: var(--primary);
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.page-header p {
    color: var(--gray);
    font-size: 1.1rem;
}

/* Dashboard Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
}

.stat-card.primary::before {
    background: var(--accent);
}

.stat-card.info::before {
    background: var(--info);
}

.stat-card.warning::before {
    background: var(--warning);
}

.stat-card.success::before {
    background: var(--success);
}

.stat-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.stat-icon {
    font-size: 2.5rem;
    opacity: 0.8;
}

.stat-value {
    font-size: 2.2rem;
    font-weight: bold;
    color: var(--primary);
    margin-bottom: 0.3rem;
}

.stat-label {
    color: var(--gray);
    font-size: 0.95rem;
}

.stat-trend {
    display: inline-block;
    margin-top: 0.5rem;
    font-size: 0.85rem;
    padding: 0.3rem 0.7rem;
    border-radius: 20px;
}

.stat-trend.up {
    background: #e8f5e9;
    color: var(--success);
}

.stat-trend.down {
    background: #ffebee;
    color: var(--danger);
}

/* Tables */
.table-container {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

thead {
    background: var(--light);
}

th {
    padding: 1rem;
    text-align: left;
    color: var(--primary);
    font-weight: 600;
}

td {
    padding: 1rem;
    border-bottom: 1px solid var(--border);
}

tr:hover {
    background: #fafafa;
}

.badge {
    display: inline-block;
    padding: 0.3rem 0.7rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.badge-success {
    background: #e8f5e9;
    color: var(--success);
}

.badge-warning {
    background: #fff3e0;
    color: var(--warning);
}

.badge-danger {
    background: #ffebee;
    color: var(--danger);
}

.badge-info {
    background: #e3f2fd;
    color: var(--info);
}

.badge-primary {
    background: var(--light);
    color: var(--primary);
}

/* Modal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
}

.modal {
    background: white;
    border-radius: 15px;
    max-width: 700px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 2px solid var(--light);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    color: var(--primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray);
    padding: 0.5rem;
}

.modal-close:hover {
    color: var(--dark);
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 2px solid var(--light);
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

/* Grid Layouts */
.grid-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.grid-3 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

/* Product/Service Cards */
.product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.product-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow);
    transition: transform 0.3s;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.product-image {
    width: 100%;
    height: 180px;
    background: var(--light);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 4rem;
    position: relative;
}

.product-category {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255,255,255,0.95);
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--primary);
}

.product-details {
    padding: 1.2rem;
}

.product-title {
    font-size: 1.2rem;
    color: var(--primary);
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.product-price {
    font-size: 1.5rem;
    color: var(--accent);
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.product-seller {
    color: var(--gray);
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.product-actions {
    display: flex;
    gap: 0.5rem;
}

/* Service Request Cards */
.request-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--shadow);
    margin-bottom: 1rem;
    border-left: 4px solid var(--accent);
}

.request-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.request-title {
    font-size: 1.2rem;
    color: var(--primary);
    font-weight: 600;
}

.request-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.request-detail-item {
    font-size: 0.9rem;
}

.request-detail-item strong {
    color: var(--gray);
    display: block;
    margin-bottom: 0.3rem;
}

.request-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

/* Inventory Management */
.inventory-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
}

.inventory-item {
    background: white;
    padding: 1.2rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
    text-align: center;
}

.inventory-icon {
    font-size: 3rem;
    margin-bottom: 0.5rem;
}

.inventory-name {
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 0.5rem;
}

.inventory-quantity {
    font-size: 1.8rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 0.3rem;
}

.inventory-unit {
    font-size: 0.9rem;
    color: var(--gray);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--gray);
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state h3 {
    margin-bottom: 0.5rem;
}

/* Charts */
.chart-container {
    position: relative;
    height: 300px;
    margin-top: 1rem;
}

/* Responsive */
@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s;
    }

    .sidebar.open {
        transform: translateX(0);
    }

    .main-content {
        margin-left: 0;
        padding: 1rem;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .grid-2,
    .grid-3 {
        grid-template-columns: 1fr;
    }

    .page-header h1 {
        font-size: 1.5rem;
    }

    .auth-box {
        padding: 2rem;
    }

    .form-row {
        grid-template-columns: 1fr;
    }
}

/* Loading Spinner */
.spinner {
    border: 3px solid var(--light);
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 2rem auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in {
    animation: fadeIn 0.3s ease-out;
}

.slide-in-up {
    animation: slideInUp 0.4s ease-out;
}

/* Notification Badge */
.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--danger);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
}

    </style>
</head>
<body>
    <div id="app"></div>
    <script>
// VermaFarm V2 - Enhanced Multi-User System
class VermaFarmApp {
    constructor() {
        this.currentUser = null;
        this.currentPage = 'login';
        this.data = this.loadData();
        this.init();
    }

    init() {
        this.checkAuth();
        this.render();
    }

    // Data Management
    loadData() {
        const savedData = localStorage.getItem('vermafarm_v2_data');
        if (savedData) {
            return JSON.parse(savedData);
        }
        return {
            users: [],
            inventory: [],
            serviceRequests: [],
            marketplace: [],
            transactions: []
        };
    }

    saveData() {
        localStorage.setItem('vermafarm_v2_data', JSON.stringify(this.data));
    }

    // Authentication
    checkAuth() {
        const savedUser = localStorage.getItem('vermafarm_v2_user');
        if (savedUser) {
            this.currentUser = JSON.parse(savedUser);
            this.currentPage = 'dashboard';
        }
    }

    login(email, password) {
        const user = this.data.users.find(u => u.email === email && u.password === password);
        if (user) {
            this.currentUser = user;
            localStorage.setItem('vermafarm_v2_user', JSON.stringify(user));
            this.currentPage = 'dashboard';
            return true;
        }
        return false;
    }

    signup(userData) {
        const existingUser = this.data.users.find(u => u.email === userData.email);
        if (existingUser) {
            return false;
        }

        const newUser = {
            id: Date.now(),
            ...userData,
            createdAt: new Date().toISOString(),
            stats: this.getInitialStats(userData.userType)
        };

        this.data.users.push(newUser);
        
        // Create initial inventory for farmers
        if (userData.userType === 'farmer') {
            this.createInitialInventory(newUser.id);
        }
        
        this.saveData();
        this.currentUser = newUser;
        localStorage.setItem('vermafarm_v2_user', JSON.stringify(newUser));
        this.currentPage = 'dashboard';
        this.render();
        return true;
    }

    getInitialStats(userType) {
        if (userType === 'farmer') {
            return {
                totalInventory: 0,
                totalSales: 0,
                activeRequests: 0,
                revenue: 0
            };
        } else if (userType === 'landowner') {
            return {
                activeProjects: 0,
                completedProjects: 0,
                serviceRevenue: 0,
                productRevenue: 0,
                serviceChargePercent: 15 // Default 15%
            };
        } else { // buyer
            return {
                totalPurchases: 0,
                spent: 0,
                activeOrders: 0
            };
        }
    }

    createInitialInventory(userId) {
        const items = [
            { type: 'poultry_waste', name: 'Poultry Waste', quantity: 0, unit: 'kg', icon: 'üêî' },
            { type: 'coconut_husk', name: 'Coconut Husk', quantity: 0, unit: 'kg', icon: 'ü••' },
            { type: 'dry_leaves', name: 'Dry Leaves', quantity: 0, unit: 'kg', icon: 'üçÇ' },
            { type: 'vermicompost', name: 'Vermicompost', quantity: 0, unit: 'kg', icon: 'üå±' }
        ];

        items.forEach(item => {
            this.data.inventory.push({
                id: Date.now() + Math.random(),
                userId,
                ...item,
                createdAt: new Date().toISOString()
            });
        });
        this.saveData();
    }

    logout() {
        this.currentUser = null;
        localStorage.removeItem('vermafarm_v2_user');
        this.currentPage = 'login';
        this.render();
    }

    // Navigation
    navigate(page) {
        this.currentPage = page;
        this.render();
    }

    // Render
    render() {
        const app = document.getElementById('app');
        
        if (!this.currentUser) {
            app.innerHTML = this.currentPage === 'login' ? this.renderLogin() : this.renderSignup();
            this.attachAuthListeners();
        } else {
            app.innerHTML = this.renderApp();
            this.attachEventListeners();
        }
    }

    // Login Page
    renderLogin() {
        return `
            <div class="auth-container">
                <div class="auth-box fade-in">
                    <div class="auth-logo">
                        <div class="logo-icon">üå±</div>
                        <h1>VermaFarm</h1>
                        <p>Smart Farming Marketplace</p>
                    </div>

                    <div id="loginError" class="hidden"></div>

                    <form id="loginForm">
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="loginEmail" required placeholder="your@email.com">
                        </div>

                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" required placeholder="Enter your password">
                        </div>

                        <button type="submit" class="btn btn-primary btn-block">Login</button>
                    </form>

                    <div class="auth-link">
                        Don't have an account? <a href="#" id="switchToSignup">Sign up here</a>
                    </div>

                    <div class="auth-link" style="margin-top: 1rem;">
                        <small style="color: var(--gray);">
                            Demo Accounts:<br>
                            Farmer: farmer@demo.com / pass123<br>
                            Land Owner: landowner@demo.com / pass123<br>
                            Buyer: buyer@demo.com / pass123
                        </small>
                    </div>
                </div>
            </div>
        `;
    }

    // Signup Page
    renderSignup() {
        return `
            <div class="auth-container">
                <div class="auth-box fade-in">
                    <div class="auth-logo">
                        <div class="logo-icon">üå±</div>
                        <h1>Join VermaFarm</h1>
                        <p>Choose your role and start your journey</p>
                    </div>

                    <div id="signupError" class="hidden"></div>

                    <form id="signupForm">
                        <div class="form-group">
                            <label>Select Your Role</label>
                            <div class="user-type-selection">
                                <div class="user-type-card" data-type="farmer">
                                    <div class="user-type-header">
                                        <span class="user-type-icon">üêî</span>
                                        <span class="user-type-title">Poultry Farmer</span>
                                    </div>
                                    <p class="user-type-description">Sell raw materials and vermicompost. Request composting services.</p>
                                    <ul class="user-type-features">
                                        <li>Manage inventory</li>
                                        <li>Sell products</li>
                                        <li>Request services</li>
                                    </ul>
                                </div>

                                <div class="user-type-card" data-type="landowner">
                                    <div class="user-type-header">
                                        <span class="user-type-icon">üèûÔ∏è</span>
                                        <span class="user-type-title">Land Owner</span>
                                    </div>
                                    <p class="user-type-description">Provide composting services and sell finished products.</p>
                                    <ul class="user-type-features">
                                        <li>Accept service requests</li>
                                        <li>Earn service charges</li>
                                        <li>Sell vermicompost</li>
                                    </ul>
                                </div>

                                <div class="user-type-card" data-type="buyer">
                                    <div class="user-type-header">
                                        <span class="user-type-icon">üõí</span>
                                        <span class="user-type-title">Buyer</span>
                                    </div>
                                    <p class="user-type-description">Purchase raw materials and finished vermicompost.</p>
                                    <ul class="user-type-features">
                                        <li>Browse marketplace</li>
                                        <li>Order products</li>
                                        <li>Track purchases</li>
                                    </ul>
                                </div>
                            </div>
                            <input type="hidden" id="signupUserType" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="signupName" required placeholder="Your name">
                            </div>

                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" id="signupEmail" required placeholder="your@email.com">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="tel" id="signupPhone" required placeholder="+91 XXXXXXXXXX">
                            </div>

                            <div class="form-group">
                                <label>Location</label>
                                <input type="text" id="signupLocation" required placeholder="City, State">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="signupPassword" required placeholder="Minimum 6 characters">
                        </div>

                        <button type="submit" class="btn btn-primary btn-block">Create Account</button>
                    </form>

                    <div class="auth-link">
                        Already have an account? <a href="#" id="switchToLogin">Login here</a>
                    </div>
                </div>
            </div>
        `;
    }

    // Main App Layout
    renderApp() {
        return `
            ${this.renderSidebar()}
            <div class="main-content">
                ${this.renderCurrentPage()}
            </div>
        `;
    }

    // Sidebar
    renderSidebar() {
        const userTypeClass = this.currentUser.userType;
        const navItems = this.getNavItems();

        return `
            <aside class="sidebar ${userTypeClass}">
                <div class="sidebar-logo">
                    <span class="icon">üå±</span>
                    <span>VermaFarm</span>
                </div>

                <div class="user-badge">
                    ${this.getUserTypeBadge()}
                </div>

                <nav>
                    <ul class="sidebar-nav">
                        ${navItems.map(item => `
                            <li><a href="#" class="${this.currentPage === item.page ? 'active' : ''}" data-page="${item.page}">
                                <span class="icon">${item.icon}</span> ${item.label}
                            </a></li>
                        `).join('')}
                    </ul>
                </nav>

                <div class="sidebar-footer">
                    <div class="user-info">
                        <div class="user-avatar">${this.currentUser.name.charAt(0).toUpperCase()}</div>
                        <div class="user-details">
                            <h4>${this.currentUser.name}</h4>
                            <p>${this.currentUser.location}</p>
                        </div>
                    </div>
                    <button class="logout-btn" id="logoutBtn">Logout</button>
                </div>
            </aside>
        `;
    }

    getUserTypeBadge() {
        const badges = {
            farmer: 'üêî Poultry Farmer',
            landowner: 'üèûÔ∏è Land Owner',
            buyer: 'üõí Buyer'
        };
        return badges[this.currentUser.userType] || 'User';
    }

    getNavItems() {
        const commonItems = [
            { page: 'dashboard', icon: 'üìä', label: 'Dashboard' },
            { page: 'marketplace', icon: 'üõí', label: 'Marketplace' }
        ];

        if (this.currentUser.userType === 'farmer') {
            return [
                ...commonItems,
                { page: 'inventory', icon: 'üì¶', label: 'My Inventory' },
                { page: 'services', icon: 'ü§ù', label: 'Service Requests' },
                { page: 'sales', icon: 'üí∞', label: 'My Sales' },
                { page: 'settings', icon: '‚öôÔ∏è', label: 'Settings' }
            ];
        } else if (this.currentUser.userType === 'landowner') {
            return [
                ...commonItems,
                { page: 'projects', icon: 'üìã', label: 'My Projects' },
                { page: 'requests', icon: 'üì©', label: 'Service Requests' },
                { page: 'production', icon: 'üè≠', label: 'Production' },
                { page: 'earnings', icon: 'üíµ', label: 'Earnings' },
                { page: 'settings', icon: '‚öôÔ∏è', label: 'Settings' }
            ];
        } else { // buyer
            return [
                ...commonItems,
                { page: 'orders', icon: 'üì¶', label: 'My Orders' },
                { page: 'wishlist', icon: '‚ù§Ô∏è', label: 'Wishlist' },
                { page: 'settings', icon: '‚öôÔ∏è', label: 'Settings' }
            ];
        }
    }

    // Current Page Router
    renderCurrentPage() {
        if (this.currentUser.userType === 'farmer') {
            return this.renderFarmerPage();
        } else if (this.currentUser.userType === 'landowner') {
            return this.renderLandOwnerPage();
        } else {
            return this.renderBuyerPage();
        }
    }

    // ===== FARMER PAGES =====
    renderFarmerPage() {
        switch (this.currentPage) {
            case 'dashboard':
                return this.renderFarmerDashboard();
            case 'inventory':
                return this.renderFarmerInventory();
            case 'services':
                return this.renderFarmerServices();
            case 'sales':
                return this.renderFarmerSales();
            case 'marketplace':
                return this.renderMarketplace();
            case 'settings':
                return this.renderSettings();
            default:
                return this.renderFarmerDashboard();
        }
    }

    renderFarmerDashboard() {
        const userInventory = this.data.inventory.filter(i => i.userId === this.currentUser.id);
        const totalInventory = userInventory.reduce((sum, i) => sum + i.quantity, 0);
        const userRequests = this.data.serviceRequests.filter(r => r.farmerId === this.currentUser.id);
        const activeRequests = userRequests.filter(r => r.status === 'pending' || r.status === 'in_progress').length;
        const userListings = this.data.marketplace.filter(m => m.sellerId === this.currentUser.id);
        const revenue = userListings.reduce((sum, l) => sum + (l.totalSold || 0) * l.pricePerUnit, 0);

        return `
            <div class="page-header">
                <h1>Welcome back, ${this.currentUser.name}! üëã</h1>
                <p>Manage your farm inventory and grow your business</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card primary slide-in-up">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${totalInventory}</div>
                            <div class="stat-label">Total Inventory (kg)</div>
                        </div>
                        <div class="stat-icon">üì¶</div>
                    </div>
                    <div class="stat-trend">Available for sale</div>
                </div>

                <div class="stat-card success slide-in-up" style="animation-delay: 0.1s;">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">‚Çπ${revenue.toLocaleString()}</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                        <div class="stat-icon">üí∞</div>
                    </div>
                    <div class="stat-trend up">‚Üë From sales</div>
                </div>

                <div class="stat-card info slide-in-up" style="animation-delay: 0.2s;">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${activeRequests}</div>
                            <div class="stat-label">Active Service Requests</div>
                        </div>
                        <div class="stat-icon">ü§ù</div>
                    </div>
                    <div class="stat-trend">${activeRequests > 0 ? 'In progress' : 'No active requests'}</div>
                </div>

                <div class="stat-card warning slide-in-up" style="animation-delay: 0.3s;">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${userListings.length}</div>
                            <div class="stat-label">Active Listings</div>
                        </div>
                        <div class="stat-icon">üõí</div>
                    </div>
                    <div class="stat-trend">On marketplace</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3>Quick Actions</h3>
                    </div>
                    <div style="display: grid; gap: 1rem;">
                        <button class="btn btn-primary" data-action="addInventory">‚ûï Add to Inventory</button>
                        <button class="btn btn-primary" data-action="listProduct">üõí List on Marketplace</button>
                        <button class="btn btn-success" data-action="requestService">ü§ù Request Composting Service</button>
                        <button class="btn btn-info" data-page="marketplace">üîç Browse Marketplace</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Recent Activity</h3>
                    </div>
                    ${this.renderFarmerActivity()}
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Current Inventory Summary</h3>
                    <button class="btn btn-sm btn-primary" data-page="inventory">View Details</button>
                </div>
                <div class="inventory-grid">
                    ${userInventory.map(item => `
                        <div class="inventory-item">
                            <div class="inventory-icon">${item.icon}</div>
                            <div class="inventory-name">${item.name}</div>
                            <div class="inventory-quantity">${item.quantity}</div>
                            <div class="inventory-unit">${item.unit}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    renderFarmerActivity() {
        return `
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.8rem; background: var(--light); border-radius: 8px;">
                    <span style="font-size: 1.8rem;">üì¶</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">Updated inventory</div>
                        <div style="font-size: 0.85rem; color: var(--gray);">2 hours ago</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.8rem; background: var(--light); border-radius: 8px;">
                    <span style="font-size: 1.8rem;">üõí</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">Listed products on marketplace</div>
                        <div style="font-size: 0.85rem; color: var(--gray);">1 day ago</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.8rem; background: var(--light); border-radius: 8px;">
                    <span style="font-size: 1.8rem;">üí∞</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">Received payment</div>
                        <div style="font-size: 0.85rem; color: var(--gray);">2 days ago</div>
                    </div>
                </div>
            </div>
        `;
    }

    renderFarmerInventory() {
        const userInventory = this.data.inventory.filter(i => i.userId === this.currentUser.id);

        return `
            <div class="page-header">
                <h1>üì¶ My Inventory</h1>
                <p>Manage your raw materials and finished products</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Inventory Management</h3>
                    <button class="btn btn-primary btn-sm" data-action="addInventory">‚ûï Update Inventory</button>
                </div>

                ${userInventory.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>No inventory yet</h3>
                        <p>Start by adding your first items</p>
                        <button class="btn btn-primary" data-action="addInventory">Add Inventory</button>
                    </div>
                ` : `
                    <div class="grid-3">
                        ${userInventory.map(item => `
                            <div class="card">
                                <div style="text-align: center; margin-bottom: 1rem;">
                                    <div style="font-size: 3.5rem; margin-bottom: 0.5rem;">${item.icon}</div>
                                    <h3 style="color: var(--primary); margin-bottom: 0.5rem;">${item.name}</h3>
                                </div>
                                
                                <div style="text-align: center; margin-bottom: 1rem;">
                                    <div style="font-size: 2.5rem; font-weight: bold; color: var(--accent);">${item.quantity}</div>
                                    <div style="color: var(--gray);">${item.unit}</div>
                                </div>

                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-primary" style="flex: 1;" data-action="updateInventory" data-id="${item.id}">Update</button>
                                    <button class="btn btn-sm btn-success" data-action="listFromInventory" data-id="${item.id}">List for Sale</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `}
            </div>
        `;
    }

    renderFarmerServices() {
        const userRequests = this.data.serviceRequests.filter(r => r.farmerId === this.currentUser.id);

        return `
            <div class="page-header">
                <h1>ü§ù Service Requests</h1>
                <p>Request composting services from land owners</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>My Service Requests</h3>
                    <button class="btn btn-primary btn-sm" data-action="requestService">‚ûï New Request</button>
                </div>

                ${userRequests.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">ü§ù</div>
                        <h3>No service requests yet</h3>
                        <p>Request composting services from land owners</p>
                        <button class="btn btn-primary" data-action="requestService">Create Request</button>
                    </div>
                ` : `
                    <div>
                        ${userRequests.map(req => this.renderServiceRequestCard(req)).join('')}
                    </div>
                `}
            </div>
        `;
    }

    renderServiceRequestCard(req) {
        const statusColors = {
            pending: 'warning',
            accepted: 'info',
            in_progress: 'info',
            completed: 'success',
            rejected: 'danger'
        };

        const landowner = req.landownerId ? this.data.users.find(u => u.id === req.landownerId) : null;

        return `
            <div class="request-card">
                <div class="request-header">
                    <div class="request-title">${req.materialType} - ${req.quantity}kg</div>
                    <span class="badge badge-${statusColors[req.status]}">${req.status.toUpperCase()}</span>
                </div>

                <div class="request-details">
                    <div class="request-detail-item">
                        <strong>Material Type</strong>
                        <div>${req.materialType}</div>
                    </div>
                    <div class="request-detail-item">
                        <strong>Quantity</strong>
                        <div>${req.quantity} kg</div>
                    </div>
                    <div class="request-detail-item">
                        <strong>Service Charge</strong>
                        <div>${req.serviceChargePercent}% of sale</div>
                    </div>
                    <div class="request-detail-item">
                        <strong>Created</strong>
                        <div>${new Date(req.createdAt).toLocaleDateString()}</div>
                    </div>
                    ${landowner ? `
                        <div class="request-detail-item">
                            <strong>Land Owner</strong>
                            <div>${landowner.name}</div>
                        </div>
                    ` : ''}
                </div>

                ${req.notes ? `
                    <div style="margin-top: 1rem; padding: 0.8rem; background: var(--light); border-radius: 8px;">
                        <strong>Notes:</strong> ${req.notes}
                    </div>
                ` : ''}

                <div class="request-actions">
                    ${req.status === 'completed' ? `
                        <button class="btn btn-sm btn-success" disabled>‚úì Completed</button>
                    ` : req.status === 'pending' ? `
                        <button class="btn btn-sm btn-danger" data-action="cancelRequest" data-id="${req.id}">Cancel Request</button>
                    ` : ''}
                </div>
            </div>
        `;
    }

    renderFarmerSales() {
        const userListings = this.data.marketplace.filter(m => m.sellerId === this.currentUser.id);
        const totalRevenue = userListings.reduce((sum, l) => sum + (l.totalSold || 0) * l.pricePerUnit, 0);
        const totalSold = userListings.reduce((sum, l) => sum + (l.totalSold || 0), 0);

        return `
            <div class="page-header">
                <h1>üí∞ My Sales</h1>
                <p>Track your marketplace listings and revenue</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card success">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">‚Çπ${totalRevenue.toLocaleString()}</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                        <div class="stat-icon">üí∞</div>
                    </div>
                </div>

                <div class="stat-card info">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${userListings.length}</div>
                            <div class="stat-label">Active Listings</div>
                        </div>
                        <div class="stat-icon">üõí</div>
                    </div>
                </div>

                <div class="stat-card primary">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${totalSold}</div>
                            <div class="stat-label">Total Sold (kg)</div>
                        </div>
                        <div class="stat-icon">üì¶</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>My Listings</h3>
                    <button class="btn btn-primary btn-sm" data-action="listProduct">‚ûï New Listing</button>
                </div>

                ${userListings.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">üõí</div>
                        <h3>No listings yet</h3>
                        <p>Start selling your products on the marketplace</p>
                        <button class="btn btn-primary" data-action="listProduct">Create Listing</button>
                    </div>
                ` : `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Available</th>
                                    <th>Sold</th>
                                    <th>Revenue</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${userListings.map(listing => `
                                    <tr>
                                        <td>${listing.productName}</td>
                                        <td><span class="badge badge-primary">${listing.category}</span></td>
                                        <td>‚Çπ${listing.pricePerUnit}/${listing.unit}</td>
                                        <td>${listing.quantityAvailable} ${listing.unit}</td>
                                        <td>${listing.totalSold || 0} ${listing.unit}</td>
                                        <td>‚Çπ${((listing.totalSold || 0) * listing.pricePerUnit).toLocaleString()}</td>
                                        <td><span class="badge badge-success">${listing.status}</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" data-action="editListing" data-id="${listing.id}">Edit</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            </div>
        `;
    }

    // ===== LAND OWNER PAGES =====
    renderLandOwnerPage() {
        switch (this.currentPage) {
            case 'dashboard':
                return this.renderLandOwnerDashboard();
            case 'projects':
                return this.renderLandOwnerProjects();
            case 'requests':
                return this.renderLandOwnerRequests();
            case 'production':
                return this.renderLandOwnerProduction();
            case 'earnings':
                return this.renderLandOwnerEarnings();
            case 'marketplace':
                return this.renderMarketplace();
            case 'settings':
                return this.renderSettings();
            default:
                return this.renderLandOwnerDashboard();
        }
    }

    renderLandOwnerDashboard() {
        const userProjects = this.data.serviceRequests.filter(r => r.landownerId === this.currentUser.id);
        const activeProjects = userProjects.filter(r => r.status === 'accepted' || r.status === 'in_progress').length;
        const completedProjects = userProjects.filter(r => r.status === 'completed').length;
        const pendingRequests = this.data.serviceRequests.filter(r => !r.landownerId && r.status === 'pending').length;
        
        const serviceRevenue = userProjects
            .filter(r => r.status === 'completed')
            .reduce((sum, r) => sum + (r.estimatedRevenue || 0) * (r.serviceChargePercent / 100), 0);

        return `
            <div class="page-header">
                <h1>Welcome back, ${this.currentUser.name}! üëã</h1>
                <p>Manage your composting projects and services</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card info slide-in-up">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${activeProjects}</div>
                            <div class="stat-label">Active Projects</div>
                        </div>
                        <div class="stat-icon">üìã</div>
                    </div>
                    <div class="stat-trend">${activeProjects > 0 ? 'In progress' : 'No active projects'}</div>
                </div>

                <div class="stat-card success slide-in-up" style="animation-delay: 0.1s;">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${completedProjects}</div>
                            <div class="stat-label">Completed Projects</div>
                        </div>
                        <div class="stat-icon">‚úÖ</div>
                    </div>
                    <div class="stat-trend up">‚Üë Total completed</div>
                </div>

                <div class="stat-card warning slide-in-up" style="animation-delay: 0.2s;">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${pendingRequests}</div>
                            <div class="stat-label">Pending Requests</div>
                        </div>
                        <div class="stat-icon">üì©</div>
                    </div>
                    <div class="stat-trend">${pendingRequests > 0 ? 'Action needed' : 'All clear'}</div>
                </div>

                <div class="stat-card primary slide-in-up" style="animation-delay: 0.3s;">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">‚Çπ${serviceRevenue.toLocaleString()}</div>
                            <div class="stat-label">Service Revenue</div>
                        </div>
                        <div class="stat-icon">üíµ</div>
                    </div>
                    <div class="stat-trend up">‚Üë From services</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3>Quick Actions</h3>
                    </div>
                    <div style="display: grid; gap: 1rem;">
                        <button class="btn btn-primary" data-page="requests">üì© View Service Requests</button>
                        <button class="btn btn-success" data-page="projects">üìã Manage Projects</button>
                        <button class="btn btn-info" data-action="listProduct">üõí List Product</button>
                        <button class="btn btn-secondary" data-page="production">üè≠ Track Production</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Recent Activity</h3>
                    </div>
                    ${this.renderLandOwnerActivity()}
                </div>
            </div>

            ${pendingRequests > 0 ? `
                <div class="card" style="border-left: 4px solid var(--warning); background: #fff8e1;">
                    <h3 style="color: var(--warning); margin-bottom: 0.5rem;">‚ö†Ô∏è New Service Requests</h3>
                    <p>You have ${pendingRequests} pending service request(s). <a href="#" data-page="requests" style="color: var(--accent); font-weight: 600;">Review now ‚Üí</a></p>
                </div>
            ` : ''}
        `;
    }

    renderLandOwnerActivity() {
        return `
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.8rem; background: var(--light); border-radius: 8px;">
                    <span style="font-size: 1.8rem;">‚úÖ</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">Completed project</div>
                        <div style="font-size: 0.85rem; color: var(--gray);">1 day ago</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.8rem; background: var(--light); border-radius: 8px;">
                    <span style="font-size: 1.8rem;">üì©</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">Accepted service request</div>
                        <div style="font-size: 0.85rem; color: var(--gray);">2 days ago</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.8rem; background: var(--light); border-radius: 8px;">
                    <span style="font-size: 1.8rem;">üíµ</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">Received service payment</div>
                        <div style="font-size: 0.85rem; color: var(--gray);">3 days ago</div>
                    </div>
                </div>
            </div>
        `;
    }

    renderLandOwnerRequests() {
        const availableRequests = this.data.serviceRequests.filter(r => !r.landownerId && r.status === 'pending');

        return `
            <div class="page-header">
                <h1>üì© Service Requests</h1>
                <p>Accept requests from farmers and earn service charges</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Available Service Requests</h3>
                </div>

                ${availableRequests.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì©</div>
                        <h3>No pending requests</h3>
                        <p>Check back later for new service requests from farmers</p>
                    </div>
                ` : `
                    <div>
                        ${availableRequests.map(req => this.renderAvailableRequestCard(req)).join('')}
                    </div>
                `}
            </div>
        `;
    }

    renderAvailableRequestCard(req) {
        const farmer = this.data.users.find(u => u.id === req.farmerId);
        const estimatedRevenue = req.quantity * 20; // Rough estimate: ‚Çπ20/kg
        const serviceCharge = estimatedRevenue * (req.serviceChargePercent / 100);

        return `
            <div class="request-card">
                <div class="request-header">
                    <div class="request-title">${req.materialType} Composting Request</div>
                    <span class="badge badge-warning">PENDING</span>
                </div>

                <div class="request-details">
                    <div class="request-detail-item">
                        <strong>Farmer</strong>
                        <div>${farmer ? farmer.name : 'Unknown'}</div>
                    </div>
                    <div class="request-detail-item">
                        <strong>Material</strong>
                        <div>${req.materialType}</div>
                    </div>
                    <div class="request-detail-item">
                        <strong>Quantity</strong>
                        <div>${req.quantity} kg</div>
                    </div>
                    <div class="request-detail-item">
                        <strong>Service Charge</strong>
                        <div>${req.serviceChargePercent}%</div>
                    </div>
                    <div class="request-detail-item">
                        <strong>Est. Your Earnings</strong>
                        <div>‚Çπ${serviceCharge.toLocaleString()}</div>
                    </div>
                    <div class="request-detail-item">
                        <strong>Location</strong>
                        <div>${farmer ? farmer.location : 'N/A'}</div>
                    </div>
                </div>

                ${req.notes ? `
                    <div style="margin-top: 1rem; padding: 0.8rem; background: var(--light); border-radius: 8px;">
                        <strong>Notes:</strong> ${req.notes}
                    </div>
                ` : ''}

                <div class="request-actions">
                    <button class="btn btn-sm btn-success" data-action="acceptRequest" data-id="${req.id}">‚úì Accept Request</button>
                    <button class="btn btn-sm btn-secondary" data-action="viewRequest" data-id="${req.id}">View Details</button>
                </div>
            </div>
        `;
    }

    renderLandOwnerProjects() {
        const userProjects = this.data.serviceRequests.filter(r => r.landownerId === this.currentUser.id);

        return `
            <div class="page-header">
                <h1>üìã My Projects</h1>
                <p>Manage your active composting projects</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Active & Completed Projects</h3>
                </div>

                ${userProjects.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No projects yet</h3>
                        <p>Accept service requests to start your first project</p>
                        <button class="btn btn-primary" data-page="requests">View Requests</button>
                    </div>
                ` : `
                    <div>
                        ${userProjects.map(proj => this.renderProjectCard(proj)).join('')}
                    </div>
                `}
            </div>
        `;
    }

    renderProjectCard(proj) {
        const farmer = this.data.users.find(u => u.id === proj.farmerId);
        const statusColors = {
            accepted: 'info',
            in_progress: 'warning',
            completed: 'success'
        };

        return `
            <div class="request-card" style="border-left-color: var(--${statusColors[proj.status]});">
                <div class="request-header">
                    <div class="request-title">${proj.materialType} Project</div>
                    <span class="badge badge-${statusColors[proj.status]}">${proj.status.toUpperCase().replace('_', ' ')}</span>
                </div>

                <div class="request-details">
                    <div class="request-detail-item">
                        <strong>Farmer</strong>
                        <div>${farmer ? farmer.name : 'Unknown'}</div>
                    </div>
                    <div class="request-detail-item">
                        <strong>Material</strong>
                        <div>${proj.materialType}</div>
                    </div>
                    <div class="request-detail-item">
                        <strong>Quantity</strong>
                        <div>${proj.quantity} kg</div>
                    </div>
                    <div class="request-detail-item">
                        <strong>Started</strong>
                        <div>${proj.acceptedAt ? new Date(proj.acceptedAt).toLocaleDateString() : 'N/A'}</div>
                    </div>
                </div>

                <div class="request-actions">
                    ${proj.status === 'accepted' ? `
                        <button class="btn btn-sm btn-warning" data-action="startProject" data-id="${proj.id}">‚ñ∂ Start Processing</button>
                    ` : proj.status === 'in_progress' ? `
                        <button class="btn btn-sm btn-success" data-action="completeProject" data-id="${proj.id}">‚úì Mark Complete</button>
                    ` : `
                        <button class="btn btn-sm btn-success" disabled>‚úì Completed</button>
                    `}
                    <button class="btn btn-sm btn-secondary" data-action="projectDetails" data-id="${proj.id}">Details</button>
                </div>
            </div>
        `;
    }

    renderLandOwnerProduction() {
        return `
            <div class="page-header">
                <h1>üè≠ Production Tracking</h1>
                <p>Monitor your vermicompost production</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Production Overview</h3>
                </div>
                <p style="text-align: center; padding: 2rem; color: var(--gray);">
                    Production tracking feature coming soon. Track batches, timelines, and quality metrics.
                </p>
            </div>
        `;
    }

    renderLandOwnerEarnings() {
        const userProjects = this.data.serviceRequests.filter(r => r.landownerId === this.currentUser.id);
        const completedProjects = userProjects.filter(r => r.status === 'completed');
        
        const serviceRevenue = completedProjects.reduce((sum, r) => {
            const estRev = r.estimatedRevenue || r.quantity * 20;
            return sum + (estRev * (r.serviceChargePercent / 100));
        }, 0);

        return `
            <div class="page-header">
                <h1>üíµ Earnings</h1>
                <p>Track your service charges and product sales</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card success">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">‚Çπ${serviceRevenue.toLocaleString()}</div>
                            <div class="stat-label">Service Revenue</div>
                        </div>
                        <div class="stat-icon">üíµ</div>
                    </div>
                    <div class="stat-trend up">‚Üë From service charges</div>
                </div>

                <div class="stat-card info">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${completedProjects.length}</div>
                            <div class="stat-label">Completed Projects</div>
                        </div>
                        <div class="stat-icon">‚úÖ</div>
                    </div>
                </div>

                <div class="stat-card primary">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${this.currentUser.stats.serviceChargePercent}%</div>
                            <div class="stat-label">Service Charge Rate</div>
                        </div>
                        <div class="stat-icon">üìä</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Earnings History</h3>
                </div>
                ${completedProjects.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">üíµ</div>
                        <h3>No earnings yet</h3>
                        <p>Complete projects to start earning</p>
                    </div>
                ` : `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Farmer</th>
                                    <th>Quantity</th>
                                    <th>Est. Sale Value</th>
                                    <th>Service Charge</th>
                                    <th>Your Earnings</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${completedProjects.map(proj => {
                                    const farmer = this.data.users.find(u => u.id === proj.farmerId);
                                    const estValue = proj.estimatedRevenue || proj.quantity * 20;
                                    const earnings = estValue * (proj.serviceChargePercent / 100);
                                    return `
                                        <tr>
                                            <td>${proj.materialType}</td>
                                            <td>${farmer ? farmer.name : 'Unknown'}</td>
                                            <td>${proj.quantity} kg</td>
                                            <td>‚Çπ${estValue.toLocaleString()}</td>
                                            <td>${proj.serviceChargePercent}%</td>
                                            <td><strong>‚Çπ${earnings.toLocaleString()}</strong></td>
                                            <td>${proj.completedAt ? new Date(proj.completedAt).toLocaleDateString() : 'N/A'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            </div>
        `;
    }

    // ===== BUYER PAGES =====
    renderBuyerPage() {
        switch (this.currentPage) {
            case 'dashboard':
                return this.renderBuyerDashboard();
            case 'marketplace':
                return this.renderMarketplace();
            case 'orders':
                return this.renderBuyerOrders();
            case 'wishlist':
                return this.renderBuyerWishlist();
            case 'settings':
                return this.renderSettings();
            default:
                return this.renderBuyerDashboard();
        }
    }

    renderBuyerDashboard() {
        const userOrders = this.data.transactions.filter(t => t.buyerId === this.currentUser.id);
        const activeOrders = userOrders.filter(t => t.status === 'pending' || t.status === 'processing').length;
        const totalSpent = userOrders.reduce((sum, t) => sum + t.totalAmount, 0);

        return `
            <div class="page-header">
                <h1>Welcome back, ${this.currentUser.name}! üëã</h1>
                <p>Browse and purchase quality products</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card info slide-in-up">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${userOrders.length}</div>
                            <div class="stat-label">Total Orders</div>
                        </div>
                        <div class="stat-icon">üì¶</div>
                    </div>
                </div>

                <div class="stat-card warning slide-in-up" style="animation-delay: 0.1s;">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${activeOrders}</div>
                            <div class="stat-label">Active Orders</div>
                        </div>
                        <div class="stat-icon">üöö</div>
                    </div>
                    <div class="stat-trend">${activeOrders > 0 ? 'In progress' : 'No active orders'}</div>
                </div>

                <div class="stat-card success slide-in-up" style="animation-delay: 0.2s;">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">‚Çπ${totalSpent.toLocaleString()}</div>
                            <div class="stat-label">Total Spent</div>
                        </div>
                        <div class="stat-icon">üí∞</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Quick Actions</h3>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <button class="btn btn-primary" data-page="marketplace">üõí Browse Marketplace</button>
                    <button class="btn btn-info" data-page="orders">üì¶ View Orders</button>
                    <button class="btn btn-secondary" data-page="wishlist">‚ù§Ô∏è My Wishlist</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Recent Orders</h3>
                    <button class="btn btn-sm btn-primary" data-page="orders">View All</button>
                </div>
                ${userOrders.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>No orders yet</h3>
                        <p>Start shopping on the marketplace</p>
                        <button class="btn btn-primary" data-page="marketplace">Browse Products</button>
                    </div>
                ` : `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${userOrders.slice(0, 5).map(order => `
                                    <tr>
                                        <td>#${order.id.toString().slice(-6)}</td>
                                        <td>${order.productName}</td>
                                        <td>${order.quantity} ${order.unit}</td>
                                        <td>‚Çπ${order.totalAmount.toLocaleString()}</td>
                                        <td><span class="badge badge-${order.status === 'completed' ? 'success' : 'warning'}">${order.status.toUpperCase()}</span></td>
                                        <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            </div>
        `;
    }

    renderBuyerOrders() {
        const userOrders = this.data.transactions.filter(t => t.buyerId === this.currentUser.id);

        return `
            <div class="page-header">
                <h1>üì¶ My Orders</h1>
                <p>Track your purchases and orders</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Order History</h3>
                </div>

                ${userOrders.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>No orders yet</h3>
                        <p>Start shopping on the marketplace</p>
                        <button class="btn btn-primary" data-page="marketplace">Browse Products</button>
                    </div>
                ` : `
                    <div>
                        ${userOrders.map(order => `
                            <div class="request-card">
                                <div class="request-header">
                                    <div class="request-title">Order #${order.id.toString().slice(-6)}</div>
                                    <span class="badge badge-${order.status === 'completed' ? 'success' : 'warning'}">${order.status.toUpperCase()}</span>
                                </div>
                                <div class="request-details">
                                    <div class="request-detail-item">
                                        <strong>Product</strong>
                                        <div>${order.productName}</div>
                                    </div>
                                    <div class="request-detail-item">
                                        <strong>Quantity</strong>
                                        <div>${order.quantity} ${order.unit}</div>
                                    </div>
                                    <div class="request-detail-item">
                                        <strong>Total Amount</strong>
                                        <div>‚Çπ${order.totalAmount.toLocaleString()}</div>
                                    </div>
                                    <div class="request-detail-item">
                                        <strong>Date</strong>
                                        <div>${new Date(order.createdAt).toLocaleDateString()}</div>
                                    </div>
                                </div>
                                <div class="request-actions">
                                    <button class="btn btn-sm btn-secondary">View Details</button>
                                    ${order.status === 'completed' ? `
                                        <button class="btn btn-sm btn-info">Reorder</button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `}
            </div>
        `;
    }

    renderBuyerWishlist() {
        return `
            <div class="page-header">
                <h1>‚ù§Ô∏è My Wishlist</h1>
                <p>Save products for later</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Saved Items</h3>
                </div>
                <div class="empty-state">
                    <div class="empty-state-icon">‚ù§Ô∏è</div>
                    <h3>Your wishlist is empty</h3>
                    <p>Browse the marketplace and save items you like</p>
                    <button class="btn btn-primary" data-page="marketplace">Browse Marketplace</button>
                </div>
            </div>
        `;
    }

    // ===== SHARED PAGES =====
    renderMarketplace() {
        const allListings = this.data.marketplace.filter(m => m.status === 'active' && m.quantityAvailable > 0);

        return `
            <div class="page-header">
                <h1>üõí Marketplace</h1>
                <p>Browse and ${this.currentUser.userType === 'buyer' ? 'purchase' : 'sell'} quality products</p>
            </div>

            ${this.currentUser.userType !== 'buyer' ? `
                <div class="card">
                    <div class="card-header">
                        <h3>Your Listings</h3>
                        <button class="btn btn-primary btn-sm" data-action="listProduct">‚ûï List Product</button>
                    </div>
                </div>
            ` : ''}

            <div class="card">
                <div class="card-header">
                    <h3>Available Products</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="categoryFilter" style="padding: 0.5rem; border-radius: 8px; border: 2px solid var(--border);">
                            <option value="">All Categories</option>
                            <option value="poultry_waste">Poultry Waste</option>
                            <option value="coconut_husk">Coconut Husk</option>
                            <option value="dry_leaves">Dry Leaves</option>
                            <option value="vermicompost">Vermicompost</option>
                        </select>
                    </div>
                </div>

                ${allListings.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">üõí</div>
                        <h3>No products available</h3>
                        <p>${this.currentUser.userType !== 'buyer' ? 'Be the first to list a product!' : 'Check back soon for new listings'}</p>
                        ${this.currentUser.userType !== 'buyer' ? `
                            <button class="btn btn-primary" data-action="listProduct">List Your Product</button>
                        ` : ''}
                    </div>
                ` : `
                    <div class="product-grid">
                        ${allListings.map(listing => this.renderProductCard(listing)).join('')}
                    </div>
                `}
            </div>
        `;
    }

    renderProductCard(listing) {
        const seller = this.data.users.find(u => u.id === listing.sellerId);
        const icons = {
            poultry_waste: 'üêî',
            coconut_husk: 'ü••',
            dry_leaves: 'üçÇ',
            vermicompost: 'üå±'
        };

        const categoryNames = {
            poultry_waste: 'Poultry Waste',
            coconut_husk: 'Coconut Husk',
            dry_leaves: 'Dry Leaves',
            vermicompost: 'Vermicompost'
        };

        return `
            <div class="product-card">
                <div class="product-image">
                    ${icons[listing.category] || 'üì¶'}
                    <div class="product-category">${categoryNames[listing.category]}</div>
                </div>
                <div class="product-details">
                    <h3 class="product-title">${listing.productName}</h3>
                    <div class="product-price">‚Çπ${listing.pricePerUnit}/${listing.unit}</div>
                    <div class="product-seller">
                        <strong>Seller:</strong> ${seller ? seller.name : 'Unknown'}<br>
                        <strong>Location:</strong> ${seller ? seller.location : 'N/A'}<br>
                        <strong>Available:</strong> ${listing.quantityAvailable} ${listing.unit}
                    </div>
                    <div class="product-actions">
                        ${this.currentUser.userType === 'buyer' ? `
                            <button class="btn btn-primary btn-sm" style="flex: 1;" data-action="buyProduct" data-id="${listing.id}">Buy Now</button>
                            <button class="btn btn-secondary btn-sm" data-action="contactSeller" data-id="${listing.id}">Contact</button>
                        ` : this.currentUser.id === listing.sellerId ? `
                            <button class="btn btn-secondary btn-sm" style="flex: 1;" data-action="editListing" data-id="${listing.id}">Edit</button>
                        ` : `
                            <button class="btn btn-info btn-sm" style="flex: 1;">View Details</button>
                        `}
                    </div>
                </div>
            </div>
        `;
    }

    renderSettings() {
        const serviceChargePercent = this.currentUser.userType === 'landowner' ? 
            (this.currentUser.stats.serviceChargePercent || 15) : null;

        return `
            <div class="page-header">
                <h1>‚öôÔ∏è Settings</h1>
                <p>Manage your account and preferences</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Profile Information</h3>
                </div>

                <form id="settingsForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" value="${this.currentUser.name}" id="settingsName">
                        </div>

                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" value="${this.currentUser.email}" id="settingsEmail" disabled>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" value="${this.currentUser.phone}" id="settingsPhone">
                        </div>

                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" value="${this.currentUser.location}" id="settingsLocation">
                        </div>
                    </div>

                    ${this.currentUser.userType === 'landowner' ? `
                        <div class="form-group">
                            <label>Service Charge Percentage</label>
                            <input type="number" value="${serviceChargePercent}" id="serviceChargePercent" min="1" max="50">
                            <small style="color: var(--gray); display: block; margin-top: 0.3rem;">
                                Your commission rate for composting services (%)
                            </small>
                        </div>
                    ` : ''}

                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        `;
    }

    // Event Listeners
    attachAuthListeners() {
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                if (this.login(email, password)) {
                    this.render();
                } else {
                    const errorDiv = document.getElementById('loginError');
                    errorDiv.className = 'alert alert-error';
                    errorDiv.textContent = 'Invalid email or password';
                }
            });
        }

        const signupForm = document.getElementById('signupForm');
        if (signupForm) {
            // User type selection
            document.querySelectorAll('.user-type-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.user-type-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    document.getElementById('signupUserType').value = card.dataset.type;
                });
            });

            signupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const userType = document.getElementById('signupUserType').value;
                if (!userType) {
                    const errorDiv = document.getElementById('signupError');
                    errorDiv.className = 'alert alert-error';
                    errorDiv.textContent = 'Please select your user type';
                    return;
                }

                const userData = {
                    userType,
                    name: document.getElementById('signupName').value,
                    email: document.getElementById('signupEmail').value,
                    phone: document.getElementById('signupPhone').value,
                    location: document.getElementById('signupLocation').value,
                    password: document.getElementById('signupPassword').value
                };

                if (this.signup(userData)) {
                    this.render();
                } else {
                    const errorDiv = document.getElementById('signupError');
                    errorDiv.className = 'alert alert-error';
                    errorDiv.textContent = 'Email already registered';
                }
            });
        }

        const switchToSignup = document.getElementById('switchToSignup');
        if (switchToSignup) {
            switchToSignup.addEventListener('click', (e) => {
                e.preventDefault();
                this.currentPage = 'signup';
                this.render();
            });
        }

        const switchToLogin = document.getElementById('switchToLogin');
        if (switchToLogin) {
            switchToLogin.addEventListener('click', (e) => {
                e.preventDefault();
                this.currentPage = 'login';
                this.render();
            });
        }
    }

    attachEventListeners() {
        // Logout
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => this.logout());
        }

        // Navigation
        document.querySelectorAll('[data-page]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                this.navigate(e.currentTarget.dataset.page);
            });
        });

        // Actions
        document.querySelectorAll('[data-action]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                this.handleAction(e.currentTarget.dataset.action, e.currentTarget.dataset.id);
            });
        });

        // Settings form
        const settingsForm = document.getElementById('settingsForm');
        if (settingsForm) {
            settingsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.currentUser.name = document.getElementById('settingsName').value;
                this.currentUser.phone = document.getElementById('settingsPhone').value;
                this.currentUser.location = document.getElementById('settingsLocation').value;
                
                if (this.currentUser.userType === 'landowner') {
                    this.currentUser.stats.serviceChargePercent = parseInt(document.getElementById('serviceChargePercent').value);
                }

                // Update in data array
                const userIndex = this.data.users.findIndex(u => u.id === this.currentUser.id);
                if (userIndex !== -1) {
                    this.data.users[userIndex] = this.currentUser;
                }

                localStorage.setItem('vermafarm_v2_user', JSON.stringify(this.currentUser));
                this.saveData();
                
                alert('Settings saved successfully!');
            });
        }
    }

    handleAction(action, id) {
        switch (action) {
            case 'addInventory':
                this.showAddInventoryModal();
                break;
            case 'updateInventory':
                this.showUpdateInventoryModal(id);
                break;
            case 'listProduct':
                this.showListProductModal();
                break;
            case 'listFromInventory':
                this.showListFromInventoryModal(id);
                break;
            case 'requestService':
                this.showRequestServiceModal();
                break;
            case 'acceptRequest':
                this.acceptServiceRequest(id);
                break;
            case 'cancelRequest':
                this.cancelServiceRequest(id);
                break;
            case 'startProject':
                this.startProject(id);
                break;
            case 'completeProject':
                this.completeProject(id);
                break;
            case 'buyProduct':
                this.showBuyProductModal(id);
                break;
            case 'contactSeller':
                this.contactSeller(id);
                break;
        }
    }

    showAddInventoryModal() {
        const userInventory = this.data.inventory.filter(i => i.userId === this.currentUser.id);
        
        const modalHTML = `
            <div class="modal-overlay" id="modalOverlay">
                <div class="modal">
                    <div class="modal-header">
                        <h2>Update Inventory</h2>
                        <button class="modal-close" id="modalClose">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="addInventoryForm">
                            ${userInventory.map(item => `
                                <div class="form-group">
                                    <label>${item.icon} ${item.name} (${item.unit})</label>
                                    <input type="number" 
                                           id="inventory_${item.id}" 
                                           value="${item.quantity}" 
                                           min="0" 
                                           step="0.1"
                                           placeholder="Enter quantity">
                                </div>
                            `).join('')}
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="modalCancel">Cancel</button>
                        <button class="btn btn-primary" id="modalSubmit">Update Inventory</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        this.attachModalListeners(() => {
            userInventory.forEach(item => {
                const input = document.getElementById(`inventory_${item.id}`);
                if (input) {
                    item.quantity = parseFloat(input.value) || 0;
                }
            });
            this.saveData();
            this.render();
        });
    }

    showUpdateInventoryModal(itemId) {
        const item = this.data.inventory.find(i => i.id === parseFloat(itemId));
        if (!item) return;

        const modalHTML = `
            <div class="modal-overlay" id="modalOverlay">
                <div class="modal">
                    <div class="modal-header">
                        <h2>Update ${item.name}</h2>
                        <button class="modal-close" id="modalClose">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="updateInventoryForm">
                            <div class="form-group">
                                <label>Current Quantity (${item.unit})</label>
                                <input type="number" id="itemQuantity" value="${item.quantity}" min="0" step="0.1" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="modalCancel">Cancel</button>
                        <button class="btn btn-primary" id="modalSubmit">Update</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        this.attachModalListeners(() => {
            item.quantity = parseFloat(document.getElementById('itemQuantity').value);
            this.saveData();
            this.render();
        });
    }

    showListProductModal() {
        const modalHTML = `
            <div class="modal-overlay" id="modalOverlay">
                <div class="modal">
                    <div class="modal-header">
                        <h2>List Product on Marketplace</h2>
                        <button class="modal-close" id="modalClose">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="listProductForm">
                            <div class="form-group">
                                <label>Product Category</label>
                                <select id="productCategory" required>
                                    <option value="">Select category</option>
                                    <option value="poultry_waste">Poultry Waste</option>
                                    <option value="coconut_husk">Coconut Husk</option>
                                    <option value="dry_leaves">Dry Leaves</option>
                                    <option value="vermicompost">Vermicompost</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Product Name</label>
                                <input type="text" id="productName" required placeholder="e.g., Premium Vermicompost">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantity Available</label>
                                    <input type="number" id="productQuantity" required min="1" step="0.1" placeholder="e.g., 100">
                                </div>

                                <div class="form-group">
                                    <label>Unit</label>
                                    <select id="productUnit" required>
                                        <option value="kg">kg</option>
                                        <option value="ton">ton</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Price per Unit (‚Çπ)</label>
                                <input type="number" id="productPrice" required min="1" step="0.1" placeholder="e.g., 20">
                            </div>

                            <div class="form-group">
                                <label>Description (optional)</label>
                                <textarea id="productDescription" placeholder="Describe your product..."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="modalCancel">Cancel</button>
                        <button class="btn btn-primary" id="modalSubmit">List Product</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        this.attachModalListeners(() => {
            const newListing = {
                id: Date.now(),
                sellerId: this.currentUser.id,
                category: document.getElementById('productCategory').value,
                productName: document.getElementById('productName').value,
                quantityAvailable: parseFloat(document.getElementById('productQuantity').value),
                unit: document.getElementById('productUnit').value,
                pricePerUnit: parseFloat(document.getElementById('productPrice').value),
                description: document.getElementById('productDescription').value,
                status: 'active',
                totalSold: 0,
                createdAt: new Date().toISOString()
            };

            this.data.marketplace.push(newListing);
            this.saveData();
            this.render();
            alert('Product listed successfully!');
        });
    }

    showListFromInventoryModal(itemId) {
        const item = this.data.inventory.find(i => i.id === parseFloat(itemId));
        if (!item) return;

        const modalHTML = `
            <div class="modal-overlay" id="modalOverlay">
                <div class="modal">
                    <div class="modal-header">
                        <h2>List ${item.name} for Sale</h2>
                        <button class="modal-close" id="modalClose">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="listFromInventoryForm">
                            <div class="alert alert-info">
                                Available in inventory: ${item.quantity} ${item.unit}
                            </div>

                            <div class="form-group">
                                <label>Product Name</label>
                                <input type="text" id="productName" value="${item.name}" required>
                            </div>

                            <div class="form-group">
                                <label>Quantity to List (${item.unit})</label>
                                <input type="number" id="productQuantity" required min="1" max="${item.quantity}" step="0.1">
                            </div>

                            <div class="form-group">
                                <label>Price per ${item.unit} (‚Çπ)</label>
                                <input type="number" id="productPrice" required min="1" step="0.1" placeholder="e.g., 20">
                            </div>

                            <div class="form-group">
                                <label>Description (optional)</label>
                                <textarea id="productDescription"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="modalCancel">Cancel</button>
                        <button class="btn btn-primary" id="modalSubmit">List for Sale</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        this.attachModalListeners(() => {
            const quantity = parseFloat(document.getElementById('productQuantity').value);
            
            if (quantity > item.quantity) {
                alert('Cannot list more than available in inventory!');
                return;
            }

            const newListing = {
                id: Date.now(),
                sellerId: this.currentUser.id,
                category: item.type,
                productName: document.getElementById('productName').value,
                quantityAvailable: quantity,
                unit: item.unit,
                pricePerUnit: parseFloat(document.getElementById('productPrice').value),
                description: document.getElementById('productDescription').value,
                status: 'active',
                totalSold: 0,
                createdAt: new Date().toISOString()
            };

            item.quantity -= quantity;
            this.data.marketplace.push(newListing);
            this.saveData();
            this.render();
            alert('Product listed successfully!');
        });
    }

    showRequestServiceModal() {
        const userInventory = this.data.inventory.filter(i => i.userId === this.currentUser.id && i.quantity > 0);

        const modalHTML = `
            <div class="modal-overlay" id="modalOverlay">
                <div class="modal">
                    <div class="modal-header">
                        <h2>Request Composting Service</h2>
                        <button class="modal-close" id="modalClose">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="requestServiceForm">
                            <div class="form-group">
                                <label>Material Type</label>
                                <select id="materialType" required>
                                    <option value="">Select material</option>
                                    ${userInventory.map(item => `
                                        <option value="${item.type}">${item.name} (${item.quantity} ${item.unit} available)</option>
                                    `).join('')}
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Quantity (kg)</label>
                                <input type="number" id="requestQuantity" required min="1" step="0.1" placeholder="e.g., 50">
                            </div>

                            <div class="form-group">
                                <label>Service Charge (% of sale price)</label>
                                <input type="number" id="serviceCharge" value="15" required min="5" max="50" step="1">
                                <small style="color: var(--gray); display: block; margin-top: 0.3rem;">
                                    Land owner's commission from final sale
                                </small>
                            </div>

                            <div class="form-group">
                                <label>Additional Notes (optional)</label>
                                <textarea id="requestNotes" placeholder="Any special requirements..."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="modalCancel">Cancel</button>
                        <button class="btn btn-primary" id="modalSubmit">Submit Request</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        this.attachModalListeners(() => {
            const materialType = document.getElementById('materialType').value;
            const quantity = parseFloat(document.getElementById('requestQuantity').value);
            const item = userInventory.find(i => i.type === materialType);

            if (quantity > item.quantity) {
                alert('Insufficient inventory! Available: ' + item.quantity + ' ' + item.unit);
                return;
            }

            const newRequest = {
                id: Date.now(),
                farmerId: this.currentUser.id,
                materialType: item.name,
                quantity,
                serviceChargePercent: parseInt(document.getElementById('serviceCharge').value),
                notes: document.getElementById('requestNotes').value,
                status: 'pending',
                createdAt: new Date().toISOString(),
                estimatedRevenue: quantity * 20 // Rough estimate
            };

            item.quantity -= quantity;
            this.data.serviceRequests.push(newRequest);
            this.saveData();
            this.render();
            alert('Service request submitted successfully!');
        });
    }

    acceptServiceRequest(requestId) {
        const request = this.data.serviceRequests.find(r => r.id === parseInt(requestId));
        if (!request) return;

        if (confirm('Accept this service request?')) {
            request.landownerId = this.currentUser.id;
            request.status = 'accepted';
            request.acceptedAt = new Date().toISOString();
            this.saveData();
            this.render();
            alert('Service request accepted! You can now start processing.');
        }
    }

    cancelServiceRequest(requestId) {
        const request = this.data.serviceRequests.find(r => r.id === parseInt(requestId));
        if (!request) return;

        if (confirm('Cancel this service request?')) {
            // Return material to inventory
            const farmer = this.data.users.find(u => u.id === request.farmerId);
            if (farmer) {
                const inventory = this.data.inventory.find(i => 
                    i.userId === farmer.id && i.name === request.materialType
                );
                if (inventory) {
                    inventory.quantity += request.quantity;
                }
            }

            request.status = 'cancelled';
            this.saveData();
            this.render();
            alert('Service request cancelled.');
        }
    }

    startProject(projectId) {
        const project = this.data.serviceRequests.find(r => r.id === parseInt(projectId));
        if (!project) return;

        project.status = 'in_progress';
        project.startedAt = new Date().toISOString();
        this.saveData();
        this.render();
        alert('Project started! Update status when composting is complete.');
    }

    completeProject(projectId) {
        const project = this.data.serviceRequests.find(r => r.id === parseInt(projectId));
        if (!project) return;

        if (confirm('Mark this project as complete?')) {
            project.status = 'completed';
            project.completedAt = new Date().toISOString();
            
            // Update earnings
            const serviceCharge = (project.estimatedRevenue || project.quantity * 20) * (project.serviceChargePercent / 100);
            this.currentUser.stats.serviceRevenue = (this.currentUser.stats.serviceRevenue || 0) + serviceCharge;
            this.currentUser.stats.completedProjects = (this.currentUser.stats.completedProjects || 0) + 1;
            
            this.saveData();
            this.render();
            alert('Project completed! Service charge has been recorded.');
        }
    }

    showBuyProductModal(listingId) {
        const listing = this.data.marketplace.find(m => m.id === parseInt(listingId));
        if (!listing) return;

        const modalHTML = `
            <div class="modal-overlay" id="modalOverlay">
                <div class="modal">
                    <div class="modal-header">
                        <h2>Purchase ${listing.productName}</h2>
                        <button class="modal-close" id="modalClose">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <form id="buyProductForm">
                            <div class="alert alert-info">
                                Available: ${listing.quantityAvailable} ${listing.unit}<br>
                                Price: ‚Çπ${listing.pricePerUnit}/${listing.unit}
                            </div>

                            <div class="form-group">
                                <label>Quantity to Purchase (${listing.unit})</label>
                                <input type="number" id="purchaseQuantity" required min="1" max="${listing.quantityAvailable}" step="0.1">
                            </div>

                            <div class="form-group">
                                <label>Total Amount</label>
                                <input type="text" id="totalAmount" readonly style="background: var(--light); font-weight: bold;">
                            </div>

                            <div class="form-group">
                                <label>Delivery Address</label>
                                <textarea id="deliveryAddress" required>${this.currentUser.location}</textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="modalCancel">Cancel</button>
                        <button class="btn btn-primary" id="modalSubmit">Place Order</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Calculate total on quantity change
        const quantityInput = document.getElementById('purchaseQuantity');
        const totalInput = document.getElementById('totalAmount');
        
        quantityInput.addEventListener('input', () => {
            const qty = parseFloat(quantityInput.value) || 0;
            const total = qty * listing.pricePerUnit;
            totalInput.value = `‚Çπ${total.toLocaleString()}`;
        });

        this.attachModalListeners(() => {
            const quantity = parseFloat(document.getElementById('purchaseQuantity').value);
            
            if (quantity > listing.quantityAvailable) {
                alert('Insufficient quantity available!');
                return;
            }

            const totalAmount = quantity * listing.pricePerUnit;

            const newOrder = {
                id: Date.now(),
                buyerId: this.currentUser.id,
                sellerId: listing.sellerId,
                listingId: listing.id,
                productName: listing.productName,
                quantity,
                unit: listing.unit,
                pricePerUnit: listing.pricePerUnit,
                totalAmount,
                deliveryAddress: document.getElementById('deliveryAddress').value,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            listing.quantityAvailable -= quantity;
            listing.totalSold = (listing.totalSold || 0) + quantity;
            
            if (listing.quantityAvailable === 0) {
                listing.status = 'sold_out';
            }

            this.data.transactions.push(newOrder);
            this.saveData();
            this.render();
            alert('Order placed successfully! The seller will contact you soon.');
        });
    }

    contactSeller(listingId) {
        const listing = this.data.marketplace.find(m => m.id === parseInt(listingId));
        if (!listing) return;

        const seller = this.data.users.find(u => u.id === listing.sellerId);
        if (!seller) return;

        alert(`Contact Seller:\n\nName: ${seller.name}\nPhone: ${seller.phone}\nLocation: ${seller.location}`);
    }

    attachModalListeners(submitCallback) {
        const closeModal = () => {
            const overlay = document.getElementById('modalOverlay');
            if (overlay) overlay.remove();
        };

        document.getElementById('modalClose')?.addEventListener('click', closeModal);
        document.getElementById('modalCancel')?.addEventListener('click', closeModal);
        
        document.getElementById('modalSubmit')?.addEventListener('click', () => {
            submitCallback();
            closeModal();
        });

        document.getElementById('modalOverlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') closeModal();
        });
    }
}

// Initialize app when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    // Create demo users if none exist
    const savedData = localStorage.getItem('vermafarm_v2_data');
    if (!savedData) {
        const initialData = {
            users: [
                {
                    id: 1,
                    userType: 'farmer',
                    name: 'Rajesh Kumar',
                    email: 'farmer@demo.com',
                    password: 'pass123',
                    phone: '+91 9876543210',
                    location: 'Thrissur, Kerala',
                    createdAt: new Date().toISOString(),
                    stats: {
                        totalInventory: 250,
                        totalSales: 3,
                        activeRequests: 1,
                        revenue: 15000
                    }
                },
                {
                    id: 2,
                    userType: 'landowner',
                    name: 'Priya Devi',
                    email: 'landowner@demo.com',
                    password: 'pass123',
                    phone: '+91 9876543211',
                    location: 'Palakkad, Kerala',
                    createdAt: new Date().toISOString(),
                    stats: {
                        activeProjects: 2,
                        completedProjects: 5,
                        serviceRevenue: 12000,
                        productRevenue: 8000,
                        serviceChargePercent: 15
                    }
                },
                {
                    id: 3,
                    userType: 'buyer',
                    name: 'Anil Verma',
                    email: 'buyer@demo.com',
                    password: 'pass123',
                    phone: '+91 9876543212',
                    location: 'Kochi, Kerala',
                    createdAt: new Date().toISOString(),
                    stats: {
                        totalPurchases: 8,
                        spent: 25000,
                        activeOrders: 2
                    }
                }
            ],
            inventory: [
                { id: 1.1, userId: 1, type: 'poultry_waste', name: 'Poultry Waste', quantity: 120, unit: 'kg', icon: 'üêî', createdAt: new Date().toISOString() },
                { id: 1.2, userId: 1, type: 'coconut_husk', name: 'Coconut Husk', quantity: 80, unit: 'kg', icon: 'ü••', createdAt: new Date().toISOString() },
                { id: 1.3, userId: 1, type: 'dry_leaves', name: 'Dry Leaves', quantity: 50, unit: 'kg', icon: 'üçÇ', createdAt: new Date().toISOString() },
                { id: 1.4, userId: 1, type: 'vermicompost', name: 'Vermicompost', quantity: 0, unit: 'kg', icon: 'üå±', createdAt: new Date().toISOString() }
            ],
            serviceRequests: [
                {
                    id: 101,
                    farmerId: 1,
                    landownerId: 2,
                    materialType: 'Poultry Waste',
                    quantity: 50,
                    serviceChargePercent: 15,
                    notes: 'High quality organic waste',
                    status: 'in_progress',
                    createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                    acceptedAt: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString(),
                    estimatedRevenue: 1000
                },
                {
                    id: 102,
                    farmerId: 1,
                    materialType: 'Coconut Husk',
                    quantity: 30,
                    serviceChargePercent: 15,
                    notes: '',
                    status: 'pending',
                    createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                    estimatedRevenue: 600
                }
            ],
            marketplace: [
                {
                    id: 201,
                    sellerId: 1,
                    category: 'dry_leaves',
                    productName: 'Premium Dry Leaves',
                    quantityAvailable: 40,
                    unit: 'kg',
                    pricePerUnit: 15,
                    description: 'Fresh organic dry leaves for composting',
                    status: 'active',
                    totalSold: 10,
                    createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 202,
                    sellerId: 2,
                    category: 'vermicompost',
                    productName: 'Grade A Vermicompost',
                    quantityAvailable: 150,
                    unit: 'kg',
                    pricePerUnit: 25,
                    description: 'Premium quality vermicompost, ready to use',
                    status: 'active',
                    totalSold: 50,
                    createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
                }
            ],
            transactions: [
                {
                    id: 301,
                    buyerId: 3,
                    sellerId: 2,
                    listingId: 202,
                    productName: 'Grade A Vermicompost',
                    quantity: 50,
                    unit: 'kg',
                    pricePerUnit: 25,
                    totalAmount: 1250,
                    deliveryAddress: 'Kochi, Kerala',
                    status: 'completed',
                    createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString()
                }
            ]
        };
        localStorage.setItem('vermafarm_v2_data', JSON.stringify(initialData));
    }

    window.app = new VermaFarmApp();
});

    </script>
</body>
</html>